{% extends "base_generic.html" %}
{% load static %}
{% load bookmarks_tags %}

{% block content %}

<link rel="stylesheet" href="{% static 'bootstrap/dist/css/bootstrap.min.css' %}" />
<link rel="stylesheet" href="{% static 'bootstrap-table/dist/bootstrap-table.min.css' %}" />
<link rel="stylesheet" href="{% static 'x-editable/dist/bootstrap-editable/css/bootstrap-editable.css' %}" />

<style>
/* use !important to override width of form-control inside editable-container */
.editable_bookscomment {
  width: 800px !important;
  /* TODO compute width from table column .editable-note */
}

.editable_bookscomment_new {
  width: 800px !important;
  color: read;
  font-style: italic; 
}

.editable-click, a.editable-click {
    text-decoration: none;
    color: #428bca;
    border-bottom: none
}
/* to remove underline / dashed border-bottom, dropped:
   border-bottom: dashed 1px #428bca
*/
.comment-date {
    width: 120px;
}
</style>

<script src="{% static '/bootstrap-table/dist/bootstrap-table.min.js' %}"></script>
<script src="{% static 'x-editable/dist/bootstrap-editable/js/bootstrap-editable.min.js' %}"></script>
<script src="{% static 'bootstrap-table/dist/extensions/editable/bootstrap-table-editable.min.js' %}"></script>

<!-- button type="button" class="btn btn-primary" ... -->
<a class="btn btn-primary btn-sm" role="button" 
  href="{% url 'bookshelf:book-update' books.pk %}">Edit Book Details</a>
<a class="btn btn-secondary btn-sm" role="button" 
  href="{% url 'bookshelf:state-update' books.pk %}">Update Book State</a>

{% if SUPPORT_TIMELINE == "1" %}
<a class="btn btn-secondary btn-sm" role="button" 
  title="timeline events for current book"
  href="{% url 'timeline:show-timeline' pk=books.pk %}"
  target="timeline"
  >Timeline events</a>
{% endif %}

{% if USE_LIBRARYTHING == "1" %}
<a class="btn btn-secondary btn-sm" role="button" 
  title="book details and reviews on LibraryThing"
  href="{% url 'bookshelf:lookup-librarything' pk=books.pk %}"
  >LibraryThing</a>
{% endif %}

{% if USE_ONLEIHE == "1" %}
<!-- currently not working, and no API documentation available -->
<a class="btn btn-secondary btn-sm" role="button" 
  title="search book in Onleihe"
  href="{% url 'bookshelf:lookup-onleihe' pk=books.pk %}"
  >Onleihe</a>
{% endif %}


<div>
<button class="btn btn-light clipboard_btn" data-clipboard-target="#book-title">
    <img src="{% static 'images/clipboard.svg' %}" alt="Copy to clipboard">
</button>
<span class="book-title" id="book-title">{{ books.book_title }}</span>
{% if books.book_serie %}
    (<span id="book-serie">{{ books.book_serie }}</span>)
{% endif %}
</div>
<script>new ClipboardJS('.clipboard_btn');</script>


<p class="mb-0"><strong>Author(s):</strong>
{% for author in books.authors.all %}
  <a href="{% url 'bookshelf:author-detail' author.pk %}">{{ author.name }}</a>{% if not forloop.last %}, {% endif %}
{% endfor %}
</p>
<p class="m-0"><strong>ISBN:</strong> 
{% if books.isbn13 %}
  {{ books.isbn13 }}
{% else %}
  {% if books.isbn10 %}
    {{ books.isbn10 }}
  {% else %}
    <i>(ISBN?)</i>
  {% endif %}
{% endif %}
</p>

<p class="m-0">
<strong>Rating:</strong> 
<a href="#" class="userrating" data-name="userRating" data-type="number" 
  data-pk="{{books.id}}" data-url="/bookshelf/books/{{books.id}}/update-userrating/" 
  data-title="rate this book" data-value="{{books.userRating|default:'3'}}">
{% if books.userRating %}
  {{ books.userRating }}
{% else %}
  (no rating)
{% endif %}
</a>
</p>

<br/>
<a href="{% url "bookmarks:bookmark-create" objtype='books' pk=books.id %}">add bookmark</a>

{% show_bookmarks books %}
<br/>

<p><strong>Description:</strong><br/> 
{% if not books.new_description %}
  {% if not books.description %}
      (missing description)
  {% else %}
      {{ books.description|safe|linebreaks }}
  {% endif %}
{% else %}
      {{ books.new_description|safe|linebreaks }}
{% endif %}
</p>
<hr/>
<p class="detail_brief">Updated: {{ books.updated|date:"c" }}</p>
<p class="detail_brief">States: {{ books.states }}</p>
<p class="detail_brief">Onleihe: <!--- to be fixed --- { { books.onleihebooks|default:'---' } } -->??</p>

<hr/>

<div style="margin-left:20px;margin-top:20px">
<h4>Comments</h4>

<table class="table table-sm booksdetail" id="bookscomments"
    data-toggle="table"
    data-id-field="comment_id"
    data-show-columns="false"
    data-show-toggle="false"
>
<thead>
  <tr>
    <th
      data-field="comment_id" 
      data-visible="false"
    >Id</th>
    <th
      id="comment_date"
    >Date</th>
    <th
        class="editable-note"
        data-editable="true"
        data-editable-mode="inline"
        data-editable-type="text"
        data-editable-inputclass="editable_bookscomment"
        data-editable-url="/bookshelf/books/{{books.id}}/update-comment/"
        style="width:100%"
    >Note</th>
<!-- 
-->
  </tr>
</thead>
<tbody>

{% for comment in books_comments %}
<tr>
<td class="comment-id small">{{ comment.id }}</td>
<td class="comment-date small">{{ comment.datetime_created }}</td>
<td class="comment-text">{{ comment.clean_text }}</td>
</tr>
{% endfor %}

<tr>
<td class="comment-id small">0</td>
<td class="comment-date small">{{comment_now}}</td>
<td 
    class="comment-text" 
    data-editable-inputclass="editable_bookscomment_new"
>(new comment)</td>
</tr>

</tbody>
</table>

<br/>
<hr/>
</div>

<script>
$('.userrating').editable({
  // mode: 'inline',  
  type: 'number',
  min: '1',
  max: '5',
  step: '1'
});

//TODO change input width using inputclass or tpl
//$('.editable-note').editable({});

</script>

{% endblock %}

